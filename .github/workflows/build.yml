name: Build and Release
permissions:
  contents: write
on:
  push:
    branches: [ "main" ]
    tags:
      - "*.*.*"
  pull_request:
    branches: [ "main" ]

jobs:

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Run Unit Tests
      run: |
        make build test

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Install dependencies
      run: |
        go install golang.org/x/tools/cmd/goimports@latest
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

    - name: Lint
      run: |
        go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.2.2
        make lint || true

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Security scan
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck -show verbose ./... || true

  build_on_macos:

    runs-on: macos-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs: [test, lint, security]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Install dependencies
      run: |
        go install golang.org/x/tools/cmd/goimports@latest

    - name: Set version
      if: github.ref_type == 'tag'
      run: |
        sed -i '' 's/version = \"dev\"/version = \"${{ github.ref_name }}\"/' cli/root.go

    - name: Build
      run: |
        GOARCH=arm64 go build -ldflags="-s -w" -o mobilecli-darwin-arm64
        GOARCH=amd64 go build -ldflags="-s -w" -o mobilecli-darwin-amd64
        ./mobilecli-darwin-arm64 --version

    - name: Upload macos build artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          mobilecli-darwin-arm64
          mobilecli-darwin-amd64
        retention-days: 1
        overwrite: true

  build_on_linux:

    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs: [test, lint, security]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Install dependencies
      run: |
        go install golang.org/x/tools/cmd/goimports@latest
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

    - name: Set version
      if: github.ref_type == 'tag'
      run: |
        sed -i 's/version = \"dev\"/version = \"${{ github.ref_name }}\"/' cli/root.go

    - name: Build
      run: |
        CGO_ENABLED=0 GOARCH=arm64 go build -ldflags="-s -w" -o mobilecli-linux-arm64
        CGO_ENABLED=0 GOARCH=amd64 go build -ldflags="-s -w" -o mobilecli-linux-amd64
        ./mobilecli-linux-amd64 --version

    - name: Upload macos build artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: |
          mobilecli-linux-arm64
          mobilecli-linux-amd64
        retention-days: 1
        overwrite: true

  build_on_windows:

    runs-on: windows-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs: [test, lint, security]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Set version
      if: github.ref_type == 'tag'
      run: |
        sed -i 's/version = \"dev\"/version = \"${{ github.ref_name }}\"/' cli/root.go

    - name: Build
      run: |
        go build -ldflags="-s -w" -o mobilecli-windows-amd64.exe
      env:
        GOARCH: amd64

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          mobilecli-windows-amd64.exe

  server_test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build_on_linux]
    steps:
    - uses: actions/checkout@v4

    - name: Download linux build
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: .

    - name: Make mobilecli executable
      run: |
        mv mobilecli-linux-amd64 mobilecli
        chmod +x mobilecli

    - name: Run server tests
      run: |
        cd test
        npm install --ignore-scripts
        npm run test -- --grep "server"

  e2e_test:
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 15
    needs: [build_on_macos]
    steps:
    - uses: actions/checkout@v4

    - name: Download macos build
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: .

    - name: Make mobilecli executable
      run: |
        mv mobilecli-darwin-arm64 mobilecli
        chmod +x mobilecli

    - name: Run E2E tests
      run: |
        cd test
        npm install --ignore-scripts
        npm test

  publish:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write  # Required for npm trusted publishing with OIDC
      contents: write
    needs: [build_on_windows, build_on_linux, build_on_macos, server_test]
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '24'
        registry-url: 'https://registry.npmjs.org'

    - name: Download darwin build
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: mobilecli-darwin

    - name: Download linux build
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: mobilecli-linux

    - name: Download windows build
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: mobilecli-windows

    - name: Zip builds
      run: |
        mkdir dist
        cd dist
        # macos-arm64
        cp ../mobilecli-darwin/mobilecli-darwin-arm64 mobilecli
        zip -9 ../mobilecli-${{ github.ref_name }}-macos-arm64.zip mobilecli
        rm -f mobilecli

        # macos-amd64
        cp ../mobilecli-darwin/mobilecli-darwin-amd64 mobilecli
        zip -9 ../mobilecli-${{ github.ref_name }}-macos-amd64.zip mobilecli
        rm -f mobilecli

        # linux-amd64
        cp ../mobilecli-linux/mobilecli-linux-amd64 mobilecli
        zip -9 ../mobilecli-${{ github.ref_name }}-linux-amd64.zip mobilecli
        rm -f mobilecli

        # linux-arm64
        cp ../mobilecli-linux/mobilecli-linux-arm64 mobilecli
        zip -9 ../mobilecli-${{ github.ref_name }}-linux-arm64.zip mobilecli
        rm -f mobilecli

        # windows-amd64
        cp ../mobilecli-windows/mobilecli-windows-amd64.exe mobilecli.exe
        zip -9 ../mobilecli-${{ github.ref_name }}-windows-amd64.zip mobilecli.exe
        rm -f mobilecli.exe
        cd ..

        ls -l *.zip
        rm -rf dist

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASES_TOKEN }}
      with:
        name: Version ${{ github.ref_name }}
        files: |
          mobilecli-*.zip

    - name: Publish
      run: |
        # prepare binaries for distribution
        mv ./mobilecli-darwin/mobilecli-darwin-arm64 publish/npm/bin
        mv ./mobilecli-darwin/mobilecli-darwin-amd64 publish/npm/bin
        mv ./mobilecli-linux/mobilecli-linux-amd64 publish/npm/bin
        mv ./mobilecli-linux/mobilecli-linux-arm64 publish/npm/bin
        mv ./mobilecli-windows/mobilecli-windows-amd64.exe publish/npm/bin
        chmod +x publish/npm/bin/*
        # copy README.md
        cp README.md publish/npm
        # publish to npm
        cd publish/npm
        npm version "${{ github.ref_name }}" --no-git-tag-version
        npm install --ignore-scripts
        npm publish --access public

